apiVersion: v1
kind: ServiceAccount
metadata:
  name: provider-vault
  namespace: {{ .Release.Namespace }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: provider-vault-token-reader
  namespace: vault
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames: ["crossplane-vault-token"]
    verbs: ["get", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: provider-vault-token-reader
  namespace: vault
subjects:
  - kind: ServiceAccount
    name: provider-vault
    namespace: {{ .Release.Namespace }}
roleRef:
  kind: Role
  name: provider-vault-token-reader
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: pkg.crossplane.io/v1beta1
kind: DeploymentRuntimeConfig
metadata:
  name: provider-vault-runtime-config
  annotations:
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  deploymentTemplate:
    spec:
      selector: {}
      template:
        spec:
          serviceAccountName: provider-vault
          containers:
            - name: package-runtime
---
apiVersion: pkg.crossplane.io/v1
kind: Provider
metadata:
  name: provider-vault
  annotations:
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
    argocd.argoproj.io/sync-wave: "1"
spec:
  package: xpkg.upbound.io/upbound/provider-vault:v3.0.3
  runtimeConfigRef:
    name: provider-vault-runtime-config
---
apiVersion: vault.m.upbound.io/v1beta1
kind: ClusterProviderConfig
metadata:
  name: vault-provider-config
  annotations:
    argocd.argoproj.io/sync-wave: "3"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  address: http://vault.vault.svc.cluster.local:8200
  credentials:
    source: Secret
    secretRef:
      namespace: vault
      name: crossplane-vault-token
      key: credentials
