apiVersion: v1
kind: ConfigMap
metadata:
  name: crossplane-config-script
  namespace: {{ .Release.Namespace }}
data:
  run.sh: |
    #!/bin/sh
    set -e

    VAULT_ADDR="http://vault-0.vault-internal:8200"

    NAMESPACE="{{ .Release.Namespace }}"
    ROOT_SECRET="vault-init-credentials"
    TOKEN_SECRET="crossplane-token"

    log() {
      echo "==> $(date '+%Y-%m-%d %H:%M:%S') | $@"
    }

    log "--- Crossplane Config Script Started ---"

    log "Installing dependencies..."
    apk add --no-cache curl jq kubectl > /dev/null
    log "Dependencies installed."

    VAULT_TOKEN=$(kubectl -n "$NAMESPACE" get secret "$ROOT_SECRET" \
              -o jsonpath='{.data.root-token}' | base64 -d)

    log "Creating 'crossplane' policy..."
    curl -s -X PUT -H "X-Vault-Token: $VAULT_TOKEN" \
        --data @- "$VAULT_ADDR/v1/sys/policies/acl/crossplane" <<'EOF'
    {
      "policy": "path \"*\" { capabilities = [\"create\",\"read\",\"update\",\"delete\",\"list\",\"sudo\"]}
    }
    EOF

    NEED_NEW_TOKEN=false
    EXISTING_TOKEN=""

    if kubectl get secret "$TOKEN_SECRET" -n "$NAMESPACE" >/dev/null 2>&1; then
      log "Found existing Secret/$TOKEN_SECRET – validating token..."
      # Extract existing token string
      EXISTING_TOKEN=$(kubectl get secret "$TOKEN_SECRET" -n "$NAMESPACE" -o jsonpath='{.data.credentials}' | base64 -d | jq -r .token)

      LOOKUP=$(curl -s -H "X-Vault-Token: $EXISTING_TOKEN" "$VAULT_ADDR/v1/auth/token/lookup-self" || true)

      if echo "$LOOKUP" | jq -e '.data' >/dev/null 2>&1; then
        POLS=$(echo "$LOOKUP" | jq -r '.data.policies[]')
        if echo "$POLS" | grep -qx crossplane; then
          log "Existing token is valid – will reuse."
        else
          log "Token valid but not bound to 'crossplane' policy – replacing."
          NEED_NEW_TOKEN=true
        fi
      else
        log "Existing token is expired or revoked – replacing."
        NEED_NEW_TOKEN=true
      fi
    else
      log "Secret/$TOKEN_SECRET not found – creating new token."
      NEED_NEW_TOKEN=true
    fi

    if [ "$NEED_NEW_TOKEN" = true ]; then
      log "Creating fresh 24‑hour renewable child token..."
      EXISTING_TOKEN=$(curl -s -X POST -H "X-Vault-Token: $VAULT_TOKEN" \
        -d '{"policies":["crossplane"],"period":"24h","ttl":"24h","display_name":"provider-vault"}' \
        "$VAULT_ADDR/v1/auth/token/create" | jq -r '.auth.client_token')
    fi

    log "Creating Secret/$TOKEN_SECRET..."
    kubectl apply -f - <<EOF
    apiVersion: v1
    kind: Secret
    metadata:
      name: $TOKEN_SECRET
      namespace: $NAMESPACE
      labels:
        app.kubernetes.io/managed-by: crossplane-config-script
    type: Opaque
    stringData:
      credentials: |
        {
          "token_name": "provider-vault",
          "token": "$EXISTING_TOKEN"
        }
    EOF

    log "--- Crossplane Config Script Finished Successfully ---"
---
apiVersion: batch/v1
kind: Job
metadata:
  generateName: "crossplane-config-"
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    argocd.argoproj.io/sync-wave: "1"
spec:
  template:
    spec:
      serviceAccountName: vault-crossplane-config-sa
      restartPolicy: OnFailure
      containers:
      - name: configurator
        image: alpine:3.20
        command: ["/bin/sh", "/config/run.sh"]
        volumeMounts:
        - name: config
          mountPath: /config
          readOnly: true
      volumes:
      - name: config
        configMap:
          name: crossplane-config-script
          defaultMode: 0755
